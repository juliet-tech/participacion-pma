<script>
  $(document).ready(function(){
    $('#reportform').on('ajax:success', function(e, data, status, xhr){
      $(console.log("Hello, Stimulus!"));
    }).on('ajax:error',function(e, xhr, status, error){
      $(console.log("Hello, Failed!"));
    });
    $("[data-toggle=popover]").popover({
      style: "max-width: 600px;"
    });
  });
</script>


<p id="notice"><%= notice %></p>
<div class="container legislationshow" data-controller="legislation">

  <h1 class="display-4"><%= @legislation.capitalized_title %></h1>
  <div class="doc-header">
    <div class="help">
      <a data-html="true" data-toggle="popover" data-trigger="hover" title="¿Cómo funciona?" data-content="<%= render 'howitworks' %>" class="badge badge-warning">Ayuda</a>
      <a href="../download_pdf" class="badge badge-primary" target="_blank">Descargar PDF</a>
    </div>
  </div>


  <div data-controller="slideshow">

<!--     <div id="Introduction" data-target="slideshow.slide" class="slide">
     <h3>Introducción</h3>
     <div class="card-header" id="headingOne">
      <h5 class="mb-0">
        <a class="btn btn-link" data-toggle="collapse" aria-expanded="true" aria-controls="collapseOne" style="white-space: normal; text-align: left;">
          <%#= render 'introduction' %>
        </a>
      </h5>
    </div> -->
  <!-- </div> -->

  <% @legislation.titles.each do |title| %>
  <div id="title<%= title.number %>" data-target="slideshow.slide" class="slide">

    <div class="title-info">
      <h3>Título <%= title.number %>: <%= title.capitalized_title %></h3>
      <p>Artículos <%= title.articles.first.number %> a <%= title.articles.last.number %> de <%= Article.all.count %></p>
      <!-- <p><%#= title.description %></p> -->
    </div>

    <div id="accordion">
      <% title.articles.order(number: :asc).each do |article| %>

      <div class="card">
        <a class="btn btn-link article" data-toggle="collapse" data-target="#collapse_<%= article.id %>" aria-expanded="true" aria-controls="collapseOne" style="white-space: normal;">
         <div class="card-header" id="headingOne">
          <!-- <div class="hello"></div> -->
          <div id="supporting-content">
            <% if Metadatum.exists?(article: article) %>
              <%# @metadata = Metadatum.find_by(article: article) %>
              <div class="flex flex-row success-badges">
                <h6 class="align-left p-2">Artículo <%= article.number %></h6>
                <p class="p-2"><button data-html="true" data-toggle="popover" data-trigger="hover" title="Artículo Modificado" class='badge badge-danger text-white popover-body' data-content="<%= render 'metadata_show', metadata: Metadatum.find_by(article: article) %>" data-boundary='scrollParent'>Modificación</button></p>
              </div>
            <% else %>
              <% if article.new == true %>
                <div class="flex flex-row success-badges">
                  <h6 class="align-left p-2">Artículo</h6>
                  <p class="p-2 badge badge-info">Nuevo</p>
                </div>
              <% else %>
                <div class="success-badges">
                  <h6 class="align-left">Artículo <%= article.number %></h6>
                </div>
              <% end %>
            <% end %>

         <!--    <div class="header-article">
              <div class="d-flex flex-row">
              <%# if article.new == true %>
                <h6 class="align-left p-2">Artículo</h6>
                <div class="p-2 badge badge-warning">Nuevo</div>
              <%# else %>
                <h6 class="align-left p-2">Artículo <%#= article.number %></h6>
                <%# if Metadatum.exists?(article: article) %>
                  <%# @metadata = Metadatum.find_by(article: article) %>
                  <a data-html="true" data-toggle="popover" data-trigger="hover" title="Artículo Modificado" data-content="<%#= render 'metadata_show', metadata: @metadata %>" class="p-2 badge badge-warning">Modificación</a>
                <%# end %>
              <%# end %>
             </div>
           -->
           <!-- </div> -->
        <!--    <div class="success-badges">
             <%# if article.questions[1].answers.exists?(consultation: current_user.consultations.last) %>
              <span class="badge badge-success" id="answered_badge">Respondido</span>
             <%# end %>

             <%# if article.questions[2].answers.exists?(consultation: current_user.consultations.last) %>
              <span class="badge badge-success" id="revised_badge">Sugerencia registrada</span>
             <%# end %>
           </div> -->
         </div>
         <p class="align-left"><%= raw article.spaced_content %></p>
         <% if article.subarticles.exists? %>
           <ol>
            <% article.subarticles.order(number: :asc).each do |subarticle|  %>
               <li>
                <p class='align-left'><%= raw subarticle.spaced_content %></p>
                <% if subarticle.subsubarticles.exists? %>
                  <ul>
                    <% subarticle.subsubarticles.order(number: :asc).each do |subsubarticle| %>
                      <li>
                        <p class='align-left'><%= raw subsubarticle.spaced_content %></p>
                      </li>
                    <% end %>
                  </ul>
                <% end %>
              </li>
             <% end %>
           </ol>
        <% end %>
       </a>
       </a>
     </div>
     <!-- </div> -->

     <div id="collapse_<%= article.id %>" class="collapse hide" aria-labelledby="headingOne" data-parent="#accordion">
      <div class="card-body" data-controller="slideshow">
        <% unless article.questions[0].answers.exists?(consultation: current_user.consultations.last) %>
        <div data-target="slideshow.slide" class="slide">
          <%= article.questions[0].content %><p>(1 = not at all, 5 = very much)</p>
          <%= form_for @answer, html: { id: "reportform" }, remote: true, update: { success: "response", failure: "error"}, method: :post do |f| %>
          <%= f.hidden_field :user_id, :value => current_user.id  %>
          <%= f.hidden_field :question_id, :value => article.questions[0].id  %>
          <%= f.hidden_field :consultation_id, :value => @consultation.id  %>
          <%= hidden_field_tag :authenticity_token, form_authenticity_token %>
          <div class="buttonspacing">
            <a data-action="slideshow#next">
              <%= f.submit '1', :name => "content", :class => 'btn-primary' %>
            </a>
            <a data-action="slideshow#next">
              <%= f.submit '2', :name => "content", :class => 'btn-primary' %>
            </a>
            <a data-action="slideshow#next">
              <%= f.submit '3', :name => "content", :class => 'btn-primary' %>
            </a>
            <a data-action="slideshow#next">
              <%= f.submit '4', :name => "content", :class => 'btn-primary' %>
            </a>
            <a data-action="slideshow#next">
              <%= f.submit '5', :name => "content", :class => 'btn-primary' %>
            </a>
          </div>
          <% end %>
        </div>
        <% end %>

        <% unless article.questions[1].answers.exists?(consultation: current_user.consultations.last) %>
        <div data-target="slideshow.slide" class="slide">
          <%= article.questions[1].content %><p>(1 = not at all, 5 = very much)</p>
          <%= form_for @answer, html: { id: "reportform" }, remote: true, update: { success: "response", failure: "error"} do |f| %>
          <%= f.hidden_field :user_id, :value => current_user.id  %>
          <%= f.hidden_field :question_id, :value => article.questions[1].id  %>
          <%= f.hidden_field :consultation_id, :value => @consultation.id  %>
          <%= hidden_field_tag :authenticity_token, form_authenticity_token %>
          <div class="buttonspacing">
            <a data-action="slideshow#next slideshow#answered">
              <%= f.submit '1', :name => "content", :class => 'btn-primary' %>
            </a>
            <a data-action="slideshow#next slideshow#answered">
              <%= f.submit '2', :name => "content", :class => 'btn-primary' %>
            </a>
            <a data-action="slideshow#next slideshow#answered">
              <%= f.submit '3', :name => "content", :class => 'btn-primary' %>
            </a>
            <a data-action="slideshow#next slideshow#answered">
              <%= f.submit '4', :name => "content", :class => 'btn-primary' %>
            </a>
            <a data-action="slideshow#next slideshow#answered">
              <%= f.submit '5', :name => "content", :class => 'btn-primary' %>
            </a>
          </div>
          <% end %>
        </div>
        <% end %>

        <% unless article.questions[2].answers.exists?(consultation: current_user.consultations.last) %>
        <div data-target="slideshow.slide" class="slide">
          <p>¿Quisieras sugerir algún comentario sobre el artículo?</p>
          <div class=" form-group buttonspacing">
            <button data-action="slideshow#next" class="btn-primary">Sí</button>
            <button data-action="slideshow#close" class="btn-primary">No</button>
          </div>
        </div>

        <div data-target="slideshow.slide" class="slide">
          <%= article.questions[2].content %>
          <%= form_for Answer.new, html: { id: "reportform" }, remote: true, update: { success: "response", failure: "error"} do |f| %>
          <div class="form-group">
            <%= f.hidden_field :user_id, :value => current_user.id  %>
            <%= f.hidden_field :question_id, :value => article.questions[2].id  %>
            <%= f.hidden_field :consultation_id, :value => @consultation.id  %>
            <%= hidden_field_tag :authenticity_token, form_authenticity_token %>
            <%= f.text_area :content, :name => "content", required: true, :class => 'form-control', placeholder: article.content %>
            <a data-action="slideshow#close slideshow#revised slideshow#next">
              <%= f.submit 'Sugiere tu revisión', :class => 'btn-primary' %>
            </a>
          </div>
          <% end %>
        </div>
        <% end %>

      </a>

    </div>
  </div>

</div>


<% end %>
</div>

</div>
<% end %>

<div class="finished row">
  <button id="continueto" style='display: none' class="btn-lg btn-primary" data-action="slideshow#next slideshow#scrolltop slideshow#showFinished">Continúa</button>
  <button id="prevbutton" style="display: none" class="btn-lg btn-primary" data-action="slideshow#previous slideshow#scrolltop slideshow#showFinished">Título Anterior</button>
  <button id="nextbutton" class="btn-lg btn-primary" data-action="slideshow#next slideshow#scrolltop slideshow#showFinished">Próximo Título</button>
  <%= link_to "Terminar la Consulta", new_consultation_general_feedback_path(@consultation), id: 'finished', class: 'btn-lg btn-primary', style: 'text-decoration: none; display: none' %>
  </div>

</div>
